<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="just.RandomColor.js"></script>
</head>

<body>
    <div id="chart_names"></div>
    <div id="chart_manufactures"></div>
    <div id="chart_marks"></div>
    <div id="chart_models"></div>
    <script>
        google.charts.load('current', {
            'packages': ['corechart']
        });
        $.ajax({
            url: "data-model.txt",
            dataType: "text",
            async: true,
            success: function (msg) {
                var data = msg.split('\n');
                dataHandler(data);
            }
        });

        function dataHandler(data) {
            var splitData = getSplitData(data),
                result = calc(splitData),
                names = result.names,
                manufacturers = result.manufacturers,
                marks = result.marks,
                models = result.models;
            drawChartByNames(names);
            drawChartByManufactures(manufacturers);
            drawChartByMarks(simplifyMarks(marks));
            drawChartByModels(simplifyModels(models), 2);
        }

        function calc(data) {
            var index,
                names = {
                    driver: 0,
                    forward: 0,
                    boot: 0,
                    kit: 0
                },
                manufacturers = {
                    stingray: 0,
                    avtogumm: 0,
                    nodata: 0
                },
                marks = {},
                models = {},
                mat;
            for (index in data) {
                mat = data[index];
                names[mat.name]++;
                manufacturers[mat.manufacturer]++;
                if (marks[mat.mark]) {
                    marks[mat.mark]++;
                    if (models[mat.mark][mat.model]) {
                        models[mat.mark][mat.model]++;
                    } else {
                        models[mat.mark][mat.model] = 1;
                    }
                    models[mat.mark].all++;
                } else {
                    marks[mat.mark] = 1;
                    models[mat.mark] = {
                        all: 1
                    };
                    models[mat.mark][mat.model] = 1;
                }
            }
            return {
                names: names,
                manufacturers: manufacturers,
                marks: marks,
                models: models
            }
        }

        function getSplitData(data) {
            var index,
                items = [];
            for (index in data) {
                items.push(getItem(data[index].toLowerCase()));
            }
            return items;
        }

        function getItem(line) {
            var item = {},
                markAndModel = getMarkAndModel(line);
            item.type = ~line.indexOf('резин') ? 'rubber' : ~line.indexOf('полиур') ? 'polyurethane' : 'nodata';
            item.name = ~line.indexOf('водит') ? 'driver' : ~line.indexOf('перед') ? 'forward' : ~line.indexOf('багаж') ? 'boot' : 'kit';
            item.manufacturer = ~line.indexOf('sting') ? 'stingray' : ~line.indexOf('gumm') ? 'avtogumm' : 'nodata';
            item.mark = markAndModel.mark;
            item.model = markAndModel.model;
            return item;
        }

        function getMarkAndModel(line) {
            var mark = '',
                model = '',
                lineInArray = line.split(' '),
                index,
                wordCount = 0,
                firstSymbol;
            for (index in lineInArray) {
                firstSymbol = lineInArray[index][0];
                if ((firstSymbol >= 'a' && firstSymbol <= 'z') || ((firstSymbol >= '1' && firstSymbol <= '9'))) {
                    if (wordCount === 0) {
                        mark = lineInArray[index];
                    }
                    if (wordCount === 1) {
                        model = lineInArray[index];
                        break;
                    }
                    wordCount++;
                }
            }
            return {
                mark: mark,
                model: model
            };
        }

        function simplifyMarks(marks) {
            var simpleMarks = {
                    other: 0
                },
                index;
            for (index in marks) {
                if (marks[index] < 5) {
                    simpleMarks.other += marks[index];
                } else {
                    simpleMarks[index] = marks[index];
                }
            }
            return simpleMarks;
        }

        function simplifyModels(models) {
            var simpleModels = [],
                indexX,
                indexY;
            for (indexX in models) {
                for(indexY in models[indexX]){
                    if(indexY && indexY !== 'all'){
                        simpleModels.push({
                            name: indexX + ' ' + indexY,
                            count: models[indexX][indexY]
                        });
                    }
                }
            }
            return simpleModels.sort(function (a, b) {
                if(a.count < b.count){
                    return 1;
                } else {
                    return -1;
                }
            });
        }

        function drawChartByNames(names) {
            var calcNames = [['', 'Кол-во покупок', {
                    role: 'style'
                }]],
                color = new just.RandomColor(),
                index;
            for (index in names) {
                calcNames.push([index, names[index], color.refresh().toHex().toCSS()]);
            }
            google.charts.setOnLoadCallback(function () {
                var data = google.visualization.arrayToDataTable(calcNames);
                // Set chart options
                var view = new google.visualization.DataView(data);
                view.setColumns([
                                    0,
                                    1,
                    {
                        calc: "stringify",
                        sourceColumn: 1,
                        type: "string",
                        role: "annotation"
                                    },
                                     2
                    ]);

                var options = {
                    title: "По типу коврика",
                    width: 1200,
                    height: 400,
                    bar: {
                        groupWidth: "95%"
                    },
                    legend: {
                        position: "none"
                    },
                };
                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.ColumnChart(document.getElementById('chart_names'));
                chart.draw(data, options);
            });
        }

        function drawChartByManufactures(manufactures) {
            var calcManufactures = [['', 'Кол-во покупок', {
                    role: 'style'
                }]],
                color = new just.RandomColor(),
                index;
            for (index in manufactures) {
                calcManufactures.push([index, manufactures[index], color.refresh().toHex().toCSS()]);
            }
            google.charts.setOnLoadCallback(function () {
                var data = google.visualization.arrayToDataTable(calcManufactures);
                // Set chart options
                var view = new google.visualization.DataView(data);
                view.setColumns([
                                0,
                                1,
                                {
                                    calc: "stringify",
                                    sourceColumn: 1,
                                    type: "string",
                                    role: "annotation"
                                },
                                2
                                ]);

                var options = {
                    title: "По производителю",
                    width: 1200,
                    height: 400,
                    bar: {
                        groupWidth: "95%"
                    },
                    legend: {
                        position: "none"
                    },
                };
                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.ColumnChart(document.getElementById('chart_manufactures'));
                chart.draw(data, options);
            });
        }

        function drawChartByMarks(marks) {
            var calcMarks = [['', 'Кол-во покупок', {
                    role: 'style'
                }]],
                color = new just.RandomColor(),
                index;
            for (index in marks) {
                calcMarks.push([index, marks[index], color.refresh().toHex().toCSS()]);
            }
            google.charts.setOnLoadCallback(function () {
                var data = google.visualization.arrayToDataTable(calcMarks);
                // Set chart options
                var view = new google.visualization.DataView(data);
                view.setColumns([
                                0,
                                1,
                                {
                                    calc: "stringify",
                                    sourceColumn: 1,
                                    type: "string",
                                    role: "annotation"
                                },
                                2
                ]);

                var options = {
                    title: "По маркам",
                    width: 1200,
                    height: 400,
                    bar: {
                        groupWidth: "95%"
                    },
                    legend: {
                        position: "none"
                    },
                };
                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.ColumnChart(document.getElementById('chart_marks'));
                chart.draw(data, options);
            });
        }
        
        function drawChartByModels(models, minCount) {
            var calcModels = [['', 'Кол-во покупок', {
                    role: 'style'
                }]],
                color = new just.RandomColor(),
                index;
            for (index = 0; index < models.length; index++) {
                if(models[index].count > minCount){
                    calcModels.push([models[index].name, models[index].count, color.refresh().toHex().toCSS()]);
                } else {
                    break;
                }
            }
            google.charts.setOnLoadCallback(function () {
                var data = google.visualization.arrayToDataTable(calcModels);
                var view = new google.visualization.DataView(data);
                view.setColumns([
                                0,
                                1,
                                {
                                    calc: "stringify",
                                    sourceColumn: 1,
                                    type: "string",
                                    role: "annotation"
                                },
                                2
                    ]);

                var options = {
                    title: "По моделям",
                    width: 1200,
                    height: 400,
                    bar: {
                        groupWidth: "95%"
                    },
                    legend: {
                        position: "none"
                    },
                };
                var chart = new google.visualization.ColumnChart(document.getElementById('chart_models'));
                chart.draw(data, options);
            });
        }
    </script>
</body>

</html>