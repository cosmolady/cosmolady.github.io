<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.full.min.js"></script>
    <script type="text/javascript" src="just.RandomColor.js"></script>
</head>

<body>
    <script>
        (function () {
            google.charts.load('current', {
                'packages': ['corechart', 'bar']
            });
            init();

            function init() {
                var url = "report.xlsx",
                    oReq = new XMLHttpRequest();
                oReq.open("GET", url, true);
                oReq.responseType = "arraybuffer";
                oReq.onload = function (e) {
                    var arraybuffer = oReq.response,
                        data = new Uint8Array(arraybuffer),
                        arr = new Array(),
                        i,
                        bstr;
                    for (i = 0; i != data.length; ++i) {
                        arr[i] = String.fromCharCode(data[i]);
                    }
                    bstr = arr.join("");
                    dataHandler(XLSX.read(bstr, {
                        type: "binary"
                    }));
                }
                oReq.send();
            }

            function dataHandler(workbook) {
                var items = excelToArray(workbook),
                    result = calc(items);
                drawChartByOrders(result.general, 'general');
                drawChartByMarks(result.marks, 'general');
                drawChartByToyotaAndHyundai(result.marks);
                drawChartByMark(result.marks.toyota.model, 'Toyota');
                drawChartByMark(result.marks.hyundai.model, 'Hyundai');
                drawChartByOrders(result.time, 'time');
                drawChartByMarksAndTime(result.marks, 'time');
            }

            function excelToArray(workbook) {
                var sheetNames = workbook.SheetNames[0],
                    sheet = workbook.Sheets[sheetNames],
                    maxRow = sheet['!ref'].split(':I')[1],
                    markColumn = 'D',
                    modelColumn = 'E',
                    timeColumn = 'F',
                    isOrderColumn = 'G',
                    isMadeColumn = 'H',
                    items = [],
                    item,
                    index;
                for (index = 2; index <= maxRow; index++) {
                    if (sheet[markColumn + index]) {
                        item = {};
                        item.mark = sheet[markColumn + index].v.toLowerCase();
                        item.model = sheet[modelColumn + index] ? sheet[modelColumn + index].w.toLowerCase() : '';
                        item.time = sheet[timeColumn + index] ? sheet[timeColumn + index].v : 0;
                        item.isOrder = sheet[isOrderColumn + index] ? true : false;
                        item.isMade = item.isOrder ? (sheet[isMadeColumn + index].v === 'нет' ? false : true) : false;
                        items.push(item);
                    }
                }
                return items;
            }

            function calc(items) {
                var index,
                    item,
                    result = {
                        general: {
                            visitors: items.length,
                            orders: 0,
                            madeOrders: 0
                        },
                        marks: {}
                    },
                    models = {};
                addTimeObj(result);
                for (index in items) {
                    item = items[index];
                    if (result.marks[item.mark]) {
                        result.marks[item.mark].visitors++;
                        checkOrder(item, result);
                        addNewModel(item, result);
                    } else {
                        result.marks[item.mark] = {
                            visitors: 1,
                            orders: 0,
                            madeOrders: 0,
                            model: {}
                        };
                        addTimeObj(result.marks[item.mark]);
                        checkOrder(item, result);
                        addNewModel(item, result);
                    }
                    addTime(item.time, result.time);
                    addTime(item.time, result.marks[item.mark].time);
                }
                return result;
            }
            function addTimeObj(obj) {
                obj.time = {
                            low: 0,
                            middle: 0,
                            high: 0
                        };
            }
            function addTime(sec, time) {
                if(sec < 10){
                    time.low++;
                } else {
                    if(sec < 30){
                        time.middle++;
                    } else {
                        time.high++;
                    }
                }
            }

            function checkOrder(item, result) {
                if (item.isOrder) {
                    result.marks[item.mark].orders++;
                    result.general.orders++;
                    if (item.isMade) {
                        result.marks[item.mark].madeOrders++;
                        result.general.madeOrders++;
                    }
                }
            }

            function addNewModel(item, result) {
                if (!result.marks[item.mark].model[item.model]) {
                    result.marks[item.mark].model[item.model] = {
                        visitors: 1,
                        orders: 0,
                        madeOrders: 0
                    }
                    addModel(item, result);
                } else {
                    addModel(item, result);
                }
            }

            function addModel(item, result) {
                if (item.isOrder) {
                    result.marks[item.mark].model[item.model].orders++;
                    if (item.isMade) {
                        result.marks[item.mark].model[item.model].madeOrders++;
                    }
                }
                result.marks[item.mark].model[item.model].visitors++;
            }

            function drawChartByOrders(general, title) {
                var calcData = [['', '', {
                        role: 'style'
                }]],
                    color = new just.RandomColor(),
                    index;
                for (index in general) {
                    calcData.push([index, general[index], color.refresh().toHex().toCSS()]);
                }
                google.charts.setOnLoadCallback(function () {
                    var data = google.visualization.arrayToDataTable(calcData);
                    var view = new google.visualization.DataView(data);
                    view.setColumns([
                                0,
                                1,
                        {
                            calc: "stringify",
                            sourceColumn: 1,
                            type: "string",
                            role: "annotation"
                                },
                                2
                    ]);

                    var options = {
                        title: title,
                        width: 1200,
                        height: 400,
                        bar: {
                            groupWidth: "95%"
                        },
                        legend: {
                            position: "none"
                        },
                        width: 600
                    };
                    $('body').append('<div id="chart_order_' + title + '"></div>');
                    var chart = new google.visualization.ColumnChart(document.getElementById('chart_order_' + title));
                    chart.draw(data, options);
                });
            }

            function drawChartByMarks(marks, title) {
                var calcMarks = [['Mark', 'Visitors', 'Orders', 'Made Orders']],
                    index,
                    mark;
                for (index in marks) {
                    mark = marks[index];
                    if (mark.orders && !(index === 'toyota' || index === 'hyundai')) {
                        calcMarks.push([index, mark.visitors, mark.orders, mark.madeOrders]);
                    }
                }
                google.charts.setOnLoadCallback(function () {
                    var data = google.visualization.arrayToDataTable(calcMarks);

                    var options = {
                        chart: {
                            title: 'По маркам'
                        }
                    };
                    $('body').append('<div id="chart_marks_' + title + '"></div>');
                    var chart = new google.charts.Bar(document.getElementById('chart_marks_' + title));

                    chart.draw(data, options);
                });
            }

            function drawChartByMark(models, name) {
                var calcModels = [[name, 'Visitors', 'Orders', 'Made Orders']],
                    index,
                    model;
                for (index in models) {
                    model = models[index];
                    if (index) {
                        calcModels.push([index, model.visitors, model.orders, model.madeOrders]);
                    }
                }
                google.charts.setOnLoadCallback(function () {
                    var data = google.visualization.arrayToDataTable(calcModels);

                    var options = {
                        chart: {
                            title: 'По ' + name
                        },
                        width: 1200
                    };
                    $('body').append('<div id="chart_' + name + '" ></div>');
                    var chart = new google.charts.Bar(document.getElementById('chart_' + name));

                    chart.draw(data, options);
                });
            }
            
            function drawChartByMarksAndTime(marks, title){
                    var calcModels = [[title, 'low', 'middle', 'high']],
                    index,
                    mark;
                for (index in marks) {
                    mark = marks[index];
                    if (index && mark.orders) {
                        calcModels.push([index, mark.time.low, mark.time.middle, mark.time.high]);
                    }
                }
                google.charts.setOnLoadCallback(function () {
                    var data = google.visualization.arrayToDataTable(calcModels);

                    var options = {
                        chart: {
                            title: title
                        },
                        width: 1200
                    };
                    $('body').append('<div id="chart_' + name + '" ></div>');
                    var chart = new google.charts.Bar(document.getElementById('chart_' + name));

                    chart.draw(data, options);
                });
            }

            function drawChartByToyotaAndHyundai(marks) {
                var calcMarks = [['Mark', 'Visitors', 'Orders', 'Made Orders']],
                    index,
                    mark;
                for (index in marks) {
                    mark = marks[index];
                    if (index === 'toyota' || index === 'hyundai') {
                        calcMarks.push([index, mark.visitors, mark.orders, mark.madeOrders]);
                    }
                }
                google.charts.setOnLoadCallback(function () {
                    var data = google.visualization.arrayToDataTable(calcMarks);

                    var options = {
                        chart: {
                            title: 'По маркам'
                        },
                        width: 600
                    };

                    $('body').append('<div id="chart_toyota_hyundai" ></div>');
                    var chart = new google.charts.Bar(document.getElementById('chart_toyota_hyundai'));

                    chart.draw(data, options);
                });
            }
        })();
    </script>
</body>

</html>